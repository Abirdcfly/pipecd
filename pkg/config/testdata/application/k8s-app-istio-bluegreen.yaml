apiVersion: pipecd.dev/v1beta1
kind: KubernetesApp
spec:
  pipeline:
    stages:
      # Deploy the workloads of STAGE variant. In this case, the number of
      # workload replicas of STAGE variant is the same with PRIMARY variant.
      - name: K8S_STAGE_ROLLOUT
        with:
          replicas: 100%
      # The percentage of traffic each variant should receive.
      # In this case, STAGE variant will receive all of the traffic.
      - name: K8S_TRAFFIC_SPLIT
        with:
          all: stage
      # Update the workload of PRIMARY variant to the new version.
      - name: K8S_PRIMARY_UPDATE
      # The percentage of traffic each variant should receive.
      # In this case, PRIMARY variant will receive all of the traffic.
      - name: K8S_TRAFFIC_SPLIT
        with:
          all: primary
      # Destroy all workloads of STAGE variant.
      - name: K8S_STAGE_CLEAN
  # Configuration for STAGE variant.
  stageVariant:
    workload:
      kind: Deployment
      name: demoapp
    service: demoapp
    suffix: stage
  # Configuration for BASELINE variant.
  baselineVariant:
    workload:
      kind: Deployment
      name: demoapp
    service: demoapp
    suffix: baseline
  # Configuration for traffic splitting.
  trafficSplit:
    method: istio # pod (change label in service to switch traffic), smi, envoy
