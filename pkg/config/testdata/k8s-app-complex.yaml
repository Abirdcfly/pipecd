kind: K8sHelmApp
spec:
  selector:
    app: demoapp
  input:
    chart: git@github.com:org/config-repo.git:charts/demoapp?ref=v1.0.0
    valueFiles:
    - values.yaml
    namespace: dev
    helmVersion: 3.1.1
  pipeline:
    stages:
      - name: K8S_CANARY_OUT
        with:
          weight: 10
          canaryService:
            name: demoapp-canary
        timeout: 10m
      - name: WAIT
        with:
          duration: 10m
      - name: ANALYSIS
        with:
          duration: 10m
          threshold: 2
          metrics:
            - query: grpc_error_percentage
              expected: < 0.1
              interval: 1m
              provider: prometheus-dev
            - useTemplate: app_http_error_percentage
          logs:
            - query: 'logName = "projects/demo/logs/error'
              interval: 1m
              provider: stackdriver-dev
          https:
            - url: https://your-endpoint.dev
              method: GET
              expected: 200
              interval: 1m
              timeout: 30s
      - name: K8S_ROLLOUT
      - name: K8S_CANARY_IN
  # List of deployments for the same commit
  # that must be succeeded before running the deployment for this application.
  requireDeployments:
    - app: demoapp
      env: dev
    - app: anotherapp
  # Make a pull request to promote other applicationzwww
  # (or promote changes through environments of the same application)
  # after the success of this deployment.
  promote:
    - app: demoapp
      env: prod
      transforms:
      - source: pipe.yaml
        destination: pipe.yaml
        regex: git@github.com:org/config-repo.git:charts/demoapp?ref=(.*)
        replacement: git@github.com:org/config-repo.git:charts/demoapp?ref={{ $1 }}
      pullRequest:
        title: Update demoapp service in prod
        commit: Update demo app service in prod
        desc: |
          Update demoapp service to {{ .App.Input.Version }}
